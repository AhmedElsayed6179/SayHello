<div class="chat-container" [ngClass]="isDarkMode ? 'dark-mode' : 'light-mode'" [class.rtl]="isRtl">

  <!-- ÿπŸÜŸàÿßŸÜ ÿßŸÑÿ¥ÿßÿ™ -->
  <h2 class="chat-title">
    {{ 'CHAT.TITLE' | translate }}
    <img src="SayHello.png" alt="Chat Icon" class="chat-icon">
  </h2>

  <!-- Messages Box -->
  <div #chatBox class="chat-box">
    <div *ngIf="showWelcome" class="welcome-wrapper text-center">
      <div class="welcome-msg system-msg">
        <div class="system-text">
          {{ 'CHAT.WELCOME1' | translate }} {{ getDisplayName(myName) }}!
        </div>
      </div>

      <div class="welcome-msg system-msg">
        <div class="system-text">
          {{ 'CHAT.WELCOME2' | translate }}
        </div>
      </div>

      <div class="welcome-msg system-msg">
        <div class="system-text">
          {{ 'CHAT.WELCOME3' | translate }}
        </div>
      </div>
    </div>

    @if (!showWelcome) {
    <div *ngFor="let msg of messages" class="message-wrapper" [ngClass]="{
           'system-msg': msg.sender === 'system',
           'message-right': msg.senderName === myName && msg.sender === 'user',
           'message-left': msg.senderName !== myName && msg.sender === 'user'
         }">

      <!-- System messages -->
      <ng-container *ngIf="msg.sender === 'system'">
        <div class="system-text">{{ msg.key | translate }}</div>
      </ng-container>

      <!-- User messages -->
      <ng-container *ngIf="msg.sender === 'user' && !msg.audioUrl">
        <div class="message-content">
          <span class="sender-name">
            {{ msg.senderName === myName ? ('CHAT.YOU' | translate) : getDisplayName(msg.senderName) }}
          </span>
          <div class="bubble-wrapper">
            <span class="bubble-text" (click)="reactToMessage(msg, '‚ù§Ô∏è')">{{ msg.text }}</span>
            <!-- ÿßŸÑÿ±Ÿäÿ£ŸÉÿ¥ŸÜ Ÿäÿ∏Ÿáÿ± ŸÅŸàŸÇ ÿßŸÑŸÅŸÇÿßÿπÿ© -->
            <div class="reaction" *ngIf="msg.reactions && msg.reactions['‚ù§Ô∏è'] && msg.reactions['‚ù§Ô∏è'].length">
              ‚ù§Ô∏è {{ msg.reactions['‚ù§Ô∏è'].length }}
            </div>
          </div>
          <small class="time-text" style="direction: ltr;">{{ msg.time }}</small>
        </div>
      </ng-container>

      <ng-container *ngIf="msg.sender === 'user' && msg.audioUrl">
        <div class="voice-message" [ngClass]="msg.senderName === myName ? 'voice-right' : 'voice-left'">

          <span class="sender-name">
            {{ msg.senderName === myName ? ('CHAT.YOU' | translate) : getDisplayName(msg.senderName) }}
          </span>

          <div class="voice-bubble" style="cursor: pointer; position: relative;"
            (click)="$event.stopPropagation(); reactToMessage(msg, '‚ù§Ô∏è')">
            <!-- ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ -->
            <button class="play-btn" (click)="togglePlay(msg); $event.stopPropagation()">
              <i class="fa" [ngClass]="msg.isPlaying ? 'fa-pause' : 'fa-play'"></i>
            </button>

            <!-- ÿßŸÑÿπŸÜÿµÿ± ÿßŸÑÿµŸàÿ™Ÿä -->
            <audio #audio [src]="msg.audioUrl"></audio>

            <!-- Slider ŸÑŸÑÿ™ÿ≠ŸÉŸÖ ŸÅŸä ÿßŸÑŸàŸÇÿ™ -->
            <input type="range" min="0" [max]="msg.duration || 0" [value]="msg.audioRef?.currentTime || 0"
              (input)="seekAudio(msg, $event)" (click)="$event.stopPropagation()" />

            <div class="wave" [class.active]="msg.isPlaying">
              <span></span><span></span><span></span><span></span>
            </div>

            <!-- ÿπÿØÿßÿØ ÿßŸÑŸàŸÇÿ™ -->
            <span class="voice-counter">{{ msg.remainingTime }}</span>

            <div class="reaction" *ngIf="msg.reactions && msg.reactions['‚ù§Ô∏è'] && msg.reactions['‚ù§Ô∏è'].length">
              ‚ù§Ô∏è {{ msg.reactions['‚ù§Ô∏è'].length }}
            </div>
          </div>

          <small class="voice-time">{{ msg.time }}</small>
        </div>
      </ng-container>
    </div>
    }

    <div *ngIf="partnerRecording" class="recording-indicator">
      {{ 'CHAT.PARTNER_RECORDING' | translate }}
    </div>

    <!-- Typing Indicator -->
    <div *ngIf="isTyping" class="typing-indicator">
      {{ 'CHAT.TYPING' | translate }}
    </div>
  </div>

  <!-- Input & Buttons -->
  <div class="input-wrapper">
    <div class="input-inner" [ngClass]="isRtl ? 'rtl' : 'ltr'">
      <input type="text" class="chat-input" [(ngModel)]="message" (keyup.enter)="sendMessage()" (input)="onTyping()"
        [disabled]="!connected || isRecording" [placeholder]="
         isRecording
           ? ''
           : (showWelcome
               ? ('CHAT.WELCOME_PLACEHOLDER' | translate)
               : ('CHAT.PLACEHOLDER' | translate))
       " />
      <!-- ÿ≤ÿ± ÿßŸÑÿ•ŸäŸÖŸàÿ¨Ÿä -->
      <button *ngIf="!showWelcome" class="emoji-btn" type="button" (click)="onOpentoggleEmoji()">üòä</button>
      <!-- ÿ≤ÿ± ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ -->
      @if(!showWelcome){
      <button class="voice-btn" *ngIf="!isRecording" (click)="onStartVoiceClick()">üé§</button>
      }
      <!-- ÿ≤ÿ± ÿßŸÑÿ•ŸäŸÇÿßŸÅ + ÿßŸÑÿ•ŸÑÿ∫ÿßÿ° + ÿßŸÑÿπÿØÿßÿØ -->
      <ng-container *ngIf="isRecording">
        <div class="cancel-container">
          <button class="voice-btn cancel-btn" *ngIf="!showWelcome" (click)="cancelRecording()">‚úñÔ∏è</button>
          <button class="voice-btn pause-btn" *ngIf="!showWelcome" (click)="togglePauseResume()">
            {{ isRecordingPaused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è' }}
          </button>
          <span *ngIf="!showWelcome" class="record-timer">{{ recordTime }}</span>
        </div>
      </ng-container>
      <!-- ÿ≤ÿ± ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ -->
      @if(!isRecording){
      <button *ngIf="!showWelcome" class="send-btn" (click)="sendMessage()">
        <i class="fa-solid fa-paper-plane"></i>
      </button>
      }
      @if(isRecording){
      <button *ngIf="!showWelcome" class="send-btn" (click)="stopRecording()">
        <i class="fa-solid fa-paper-plane"></i>
      </button>
      }
    </div>

    <emoji-picker *ngIf="showEmoji" (emoji-click)="onEmojiSelect($event)" [ngStyle]="{
    'bottom.px': 120,
    'left.px': isRtl ? null : 3,
    'right.px': isRtl ? 0 : null
  }" class="emoji-picker">
    </emoji-picker>

    <!-- Action buttons -->
    <div class="action-buttons">
      <button *ngIf="!showWelcome" class="next-btn" [class.confirm]="confirmNext" (click)="onNextClick()">
        {{ confirmNext ? confirmText : ('CHAT.NEXT' | translate) }}
      </button>
      <button *ngIf="!showWelcome" class="exit-btn" [class.confirm]="exitConfirm" (click)="onExitClick()">
        {{ exitConfirm ? confirmText : ('CHAT.STOP' | translate) }}
      </button>
      <button *ngIf="showWelcome" class="start-btn" (click)="startChat()">
        {{ 'CHAT.START' | translate }}
      </button>
    </div>
  </div>

  <!-- Waiting State -->
  <!-- <div *ngIf="waiting && !connected" class="waiting-text">
    {{ 'CHAT.WAITING' | translate }}
  </div> -->
</div>
